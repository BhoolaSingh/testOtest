<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Result</title>
    <link rel="stylesheet" href="result.css"> <!-- Link to the new result CSS file -->
</head>
<body>
    <div class="result-container">
        <h1>Quiz Results</h1>
        <div class="candidate-info">
            <p>Candidate Name: <span id="candidateName"></span></p> <!-- Section for candidate name -->
        </div>
        <div class="result-info">
            <p>Your Score: <span id="score"></span></p>
            <p>Accuracy: <span id="accuracy"></span>%</p>
            <p>Time Taken: <span id="timeTaken"></span> minutes</p>
        </div>
        <div class="button-container">
            <button id="submitScoreButton">Submit Your Score</button> <!-- New submit button -->
        </div>
        <div id="submissionMessage" style="display:none;">Submitting your score...</div>
    </div>

    <script>
        // Firebase Firestore setup (Ensure Firebase is initialized elsewhere in your project)
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Function to retrieve and display quiz results from sessionStorage
        function displayQuizResults() {
            // Get the quiz results from sessionStorage
            const score = sessionStorage.getItem('quizScore');
            const timeTaken = sessionStorage.getItem('timeTaken');
            const accuracy = sessionStorage.getItem('accuracy');

            // Check if the results are available
            if (score !== null && timeTaken !== null && accuracy !== null) {
                // Convert time from seconds to minutes and seconds
                const timeInMinutes = Math.floor(timeTaken / 60);
                const timeInSeconds = timeTaken % 60;

                // Display the quiz results on the page
                document.getElementById('score').textContent = score;
                document.getElementById('accuracy').textContent = parseFloat(accuracy).toFixed(2);
                document.getElementById('timeTaken').textContent = timeInMinutes + ' min ' + timeInSeconds + ' sec';
            } else {
                console.error("Quiz results are not available in sessionStorage");
            }
        }

        // Function to retrieve candidate name from Firestore
        function retrieveCandidateName() {
            const userId = localStorage.getItem('loggedInUserId');
            
            if (userId) {
                const userRef = db.collection("users").doc(userId);
                
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('candidateName').textContent = userData.firstName + ' ' + userData.lastName;
                        sessionStorage.setItem('candidateName', userData.firstName + ' ' + userData.lastName); // Save to sessionStorage for later use
                    } else {
                        console.error("No user document found!");
                    }
                }).catch((error) => {
                    console.error("Error retrieving user data:", error);
                });
            } else {
                console.error("No logged-in user ID found in localStorage");
            }
        }

        // Function to submit quiz results to Firestore
        function submitQuizResults() {
            const score = sessionStorage.getItem('quizScore');
            const timeTaken = sessionStorage.getItem('timeTaken');
            const accuracy = sessionStorage.getItem('accuracy');
            const userId = localStorage.getItem('loggedInUserId');

            if (score !== null && timeTaken !== null && accuracy !== null && userId) {
                const userRef = db.collection("users").doc(userId);
                const quizData = {
                    score: parseInt(score),
                    accuracy: parseFloat(accuracy),
                    timeTaken: parseInt(timeTaken),
                    submissionDate: new Date()
                };

                document.getElementById('submissionMessage').style.display = 'block'; // Show the loading indicator

                userRef.set({ quizResults: quizData }, { merge: true })
                    .then(() => {
                        document.getElementById('submissionMessage').textContent = 'Score submitted successfully!';
                    })
                    .catch((error) => {
                        document.getElementById('submissionMessage').textContent = 'Error submitting score.';
                        console.error("Error submitting quiz results:", error);
                    });
            } else {
                console.error("Quiz results or user information missing.");
            }
        }

        // Add event listener to the Submit Score button
        document.getElementById('submitScoreButton').addEventListener('click', submitQuizResults);

        // Call functions to display quiz results and retrieve candidate name when the page loads
        displayQuizResults();
        retrieveCandidateName();
    </script>
</body>
</html>
